

# åˆ—è¡¨æµè§ˆåŸ‹ç‚¹ä¸ŠæŠ¥è§£å†³æ–¹æ¡ˆå®ç°

## åŸ‹ç‚¹ç®€ä»‹

### ä»€ä¹ˆæ˜¯æ•°æ®åŸ‹ç‚¹

æ‰€è°“â€œåŸ‹ç‚¹â€å°±æ˜¯ä¸€ç§æ•°æ®é‡‡é›†çš„æ–¹å¼ï¼Œæ˜¯æ•°æ®é‡‡é›†é¢†åŸŸçš„æœ¯è¯­ï¼ŒæŒ‡çš„æ˜¯é’ˆå¯¹ç‰¹å®šç”¨æˆ·è¡Œä¸ºæˆ–æ—¶é—´è¿›è¡Œæ•è·ã€å¤„ç†å’Œå‘é€ç›¸å…³æŠ€æœ¯åŠå…¶å®æ–½è¿‡ç¨‹ã€‚ç›®å‰å¸¸è§çš„å‰ç«¯åŸ‹ç‚¹æ–¹æ³•ä¸»è¦åˆ†ä¸ºä¸‰ç§ï¼šä»£ç åŸ‹ç‚¹ã€å¯è§†åŒ–åŸ‹ç‚¹å’Œæ— ç—•åŸ‹ç‚¹ï¼Œè€Œæœ¬æ¬¡æƒ³è¦åˆ†åˆ†äº«çš„åˆ—è¡¨æµè§ˆåŸ‹ç‚¹ä¸ŠæŠ¥è§£å†³æ–¹æ¡ˆåˆ™ä¸ºä»£ç åŸ‹ç‚¹çš„ä¸€ä¸ªåº”ç”¨åœºæ™¯ã€‚

### åº”ç”¨åœºæ™¯

æœ€è¿‘åœ¨é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°è¿™ä¹ˆä¸€ä¸ªåŸ‹ç‚¹éœ€æ±‚ï¼šç»™å•†å“ç€‘å¸ƒæµæ·»åŠ æµè§ˆæ•°æ®åŸ‹ç‚¹ï¼Œå½“ç”¨æˆ·æµè§ˆæ»šåŠ¨æµè§ˆå•†å“ç€‘å¸ƒæµå¹¶åœç•™æ—¶ï¼Œä¸ŠæŠ¥æ‰€æœ‰å®Œæ•´å‡ºç°åœ¨ç”¨è®¾å¤‡çª—å£ä¸Šçš„å•†å“åˆ—è¡¨æ•°æ®åŸ‹ç‚¹ï¼Œå½“å†æ¬¡æµè§ˆåˆ°å½“å‰å•†å“æ—¶ï¼Œè¿‡æ»¤æ‰å·²ä¸ŠæŠ¥è¿‡çš„å•†å“åç»§ç»­ä¸ŠæŠ¥æ•°æ®åŸ‹ç‚¹ã€‚

## å®ç°æ–¹æ¡ˆ

å¯¹äºè¿™ä¸ªäº§å“éœ€æ±‚ï¼Œæˆ‘ä»¬ä¸åº”è¯¥è€ƒè™‘å®ƒçš„å®ç°æ„ä¹‰ä½•åœ¨ï¼Œè€Œæ˜¯é¦–å…ˆç ”è®¨å¯è¡Œçš„å®ç°æ–¹æ¡ˆï¼Œå½“ç„¶è¿™ä»…ä»…æœ¬äººä¸ªäººçš„å°å°çš„å‘ç‰¢éªšï¼Œè¯·å¤§å®¶ä¸è¦ä»‹æ„ï¼Œä¸‹é¢è¿›å…¥æ­£é¢˜ï¼Œå¯¹æ­¤éœ€æ±‚ï¼Œæœ€ç»ˆçš„ç¡®å®šä¸‹æ¥å®ç°æ–¹æ¡ˆå¦‚ä¸‹ï¼š

1. ç›‘å¬é¡µé¢æ»šåŠ¨åœç•™
2. è®¡ç®—å‡ºåœç•™çª—å£å†…çš„å•†å“åˆ—è¡¨
3. ä¸ŠæŠ¥è¿‡æ»¤åçš„å•†å“åˆ—è¡¨æ•°æ®

### 1. ç›‘å¬å±å¹•åœç•™

æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæµè§ˆå™¨å¹¶æ²¡æœ‰æä¾›ç›‘å¬å±å¹•æ»šåŠ¨åœç•™çš„äº‹ä»¶ï¼Œé‚£ä¹ˆå¦‚ä½•æ‰èƒ½å®ç°ç›‘å¬å±å¹•æ»šåŠ¨åœç•™å‘¢ï¼Ÿæ–¹æ³•å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯é€šè¿‡ç›‘å¬å±å¹•æ»šåŠ¨äº‹ä»¶æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œé€šè¿‡è¿™ä¸ªå›è°ƒå‡½æ•°é€šè¿‡èŠ‚æµçš„æ–¹å¼è§¦å‘çœŸæ­£çš„å±å¹•åœç•™å›è°ƒå‡½æ•°ã€‚

ä½†æ˜¯ï¼Œé€šè¿‡ç›‘å¬å±å¹•æ»šåŠ¨èŠ‚æµçš„æ–¹å¼ä¼šå­˜åœ¨ä¸€ç§ç¼ºé™·ï¼Œå°±æ˜¯å½“ç”¨æˆ·æ»šåŠ¨åœç•™æ—¶å¹¶ä¸”åœ¨èŠ‚æµæ—¶é—´å°šæœªåˆ°å°±åˆ‡æ¢é¡µé¢çª—å£æ—¶ï¼Œä¾ç„¶ä¼šä¸ŠæŠ¥åŸ‹ç‚¹ã€‚æ‰€ä»¥ï¼Œéœ€è¦åŒæ—¶ç›‘å¬é¡µé¢éšè—äº‹ä»¶è§¦å‘æ¸…é™¤å±å¹•åœç•™å›è°ƒçš„è®¡æ—¶å™¨ï¼Œç›‘å¬é¡µé¢æ˜¾ç¤ºäº‹ä»¶è§¦å‘é‡æ–°åˆ›å»ºå±å¹•å›è°ƒçš„è®¡æ—¶å™¨ï¼Œè¿™æ ·ï¼Œæ‰èƒ½ä¿è¯æ•°æ®ä¸ŠæŠ¥çš„å‡†ç¡®æ€§ã€‚

ç”±äºè¯¥é¡¹ç›®æ˜¯åŸºäºVueå®ç°çš„ï¼Œå› æ­¤ä¸ºäº†åŸ‹ç‚¹æ–¹æ¡ˆä»£ç çš„å¯å¤ç”¨æ€§ï¼Œæˆ‘ä»¬é‡‡ç”¨mixinçš„é€»è¾‘å¤ç”¨æ–¹å¼ï¼Œæ˜¾ç°ä»£ç å¦‚ä¸‹ï¼š

```js
// page-event.js
import Vue from 'vue';

export default Vue.extend({
  methods: {
    /**
     * é¡µé¢æ˜¾ç¤ºhook
     * ä»å…¶ä»–çª—å£åˆ‡æ¢åˆ°å½“å‰é¡µé¢è§¦å‘æ‰§è¡Œ
     * @param {function} callback 
     */
    onShow(callback) {
      const handler = () => {
        if (document.visibilityState === 'visible') {
          callback && callback();
        }
      };
      document.addEventListener('visibilitychange', handler);
      this.$once('hook:beforeDestroy', () => {
        document.removeEventListener('visibilitychange', handler);
      });
    },
    /**
     * é¡µé¢éšè—hook
     * ä»å½“å‰é¡µé¢åˆ‡æ¢åˆ°å…¶ä»–é¡µé¢è§¦å‘æ‰§è¡Œ
     * @param {function} callback 
     */
    onHide(callback) {
      const handler = () => {
        if (document.visibilityState === 'hidden') {
          callback && callback();
        }
      };
      document.addEventListener('visibilitychange', handler);
      this.$once('hook:beforeDestroy', () => {
        document.removeEventListener('visibilitychange', handler);
      });
    },
    /**
     * é¡µé¢æ»šåŠ¨hook
     * å½“å‘é¡µé¢æ»šåŠ¨æ—¶è§¦å‘æ‰§è¡Œ
     * @param {function} callback 
     */
    onPageScroll(callback) {
      const handler = () => {
        callback && callback();
      }
      document.addEventListener('scroll', handler);
      this.$once('hook:beforeDestroy', () => {
        document.removeEventListener('scroll', handler);
      });
    },
  },
});


// stay-screen.js
import Vue from 'vue';
import pageEvent from './page-event';

export default Vue.extend({
  mixins: [
    pageEvent
  ],
  data() {
    return {
      stayStarted: false,
      stayShow: false,
      stayPaused: false,
      stayTimeoutId: null,
      stayTime: 1000,
      stayScreenCallback: null, // å±åœç•™æ‰§è¡Œå›è°ƒ
    }
  },
  created() {
    this.onShow(this.stayOnShow);
    this.onHide(this.stayOnHide);
    this.onPageScroll(this.stayOnScroll);
  },
  methods: {
    /**
     * å¼€å§‹é¡µé¢æ»šåŠ¨åè®¡ç®—é¡µé¢åœç•™
     * stayTimeæ—¶é—´è¿‡åï¼Œè§¦å‘åœç•™æ‰§è¡Œå›è°ƒ
     * é»˜è®¤å¼€å§‹ä¸è§¦å‘å±å¹•åœç•™è®¡ç®—
     */
    startStay() {
      if (!this.stayStarted) {
        return;
      }
      this.stayTimeoutId = setTimeout(() => {
        this.stayTimeoutId = null;
        if (this.stayScreenCallback) {
          this.stayScreenCallback();
        }
      }, this.stayTime);
    },
    /** æš‚åœè®¡ç®—é¡µé¢åœç•™ */
    pauseStay() {
      if (!this.stayStarted) {
        return;
      }
      this.stayPaused = true;
      this.clearStay();
    },
    /** ç»§ç»­è®¡ç®—é¡µé¢åœç•™ */
    continueStay() {
      if (!this.stayStarted || !this.stayShow) {
        return;
      }
      if (this.stayPaused) {
        this.stayPaused = false;
        this.startStay();
      }
    },
    /** é‡æ–°è®¡ç®—é¡µé¢åœç•™ */
    restartStay() {
      if (!this.stayStarted || !this.stayShow) {
        return;
      }
      this.clearStay();
      this.startStay();
    },
    /** æ¸…é™¤è®¡ç®—é¡µé¢åœç•™ */
    clearStay() {
      if (this.stayTimeoutId) {
        clearTimeout(this.stayTimeoutId);
        this.stayTimeoutId = null;
      }
    },
    /**
     * åˆå§‹åŒ–è®¡ç®—åœç•™
     * æ‰§è¡Œè§¦å‘å¼€å§‹è®¡ç®—é¡µé¢åœç•™
     */
    stayInit() {
      if (!this.stayStarted) {
        this.stayStarted = true;
        this.stayShow = true;
        this.startStay();
      }
    },
    /** æ»šåŠ¨åˆ·æ–°è®¡ç®—é¡µé¢åœç•™ */
    stayOnScroll() {
      this.restartStay();
    },
    /** é¡µé¢æ˜¾ç¤ºæ—¶ç»§ç»­è®¡ç®—é¡µé¢åœç•™ */
    stayOnShow() {
      this.stayShow = true;
      this.continueStay();
    },
    /** é¡µé¢éšè—æ—¶æš‚åœè®¡ç®—é¡µé¢åœç•™ */
    stayOnHide() {
      this.stayShow = false;
      this.pauseStay();
    }
  }
});
```



### 2. è®¡ç®—åœç•™çª—å£å•†å“åˆ—è¡¨

è®¡ç®—åœç•™çª—å£å†…çš„å•†å“ä¿¡æ¯ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°ä¸€ä¸ªAPIæ–¹æ³•`Element.getBoundingClientRect`ï¼Œè¯¥æ–¹æ³•è¿”å›å…ƒç´ çš„å¤§å°åŠå…¶ç›¸å¯¹è§†å£çš„ä½ç½®ã€‚è¿™æ ·æˆ‘ä»¬å°±èƒ½é€šè¿‡æ‰€æœ‰åˆ—è¡¨å…ƒç´ å¹¶è®¡ç®—å…¶æ˜¯å¦å­˜åœ¨äºè§†å›¾çª—å£ä¸Šï¼Œå¯æ˜¯å±å¹•æ»šåŠ¨äº‹ä»¶å¤ªè¿‡äºé¢‘ç¹ï¼Œæ¯æ¬¡åœ¨å±å¹•åœç•™åå¾ªç¯è®¡ç®—ç¬¦åˆå…ƒç´ ä¿¡æ¯çš„è®¡ç®—æ–¹æ¡ˆä¼¼ä¹å¹¶ä¸ç†æƒ³ï¼Œæœ‰å¤ªå¤šçš„æ²¡å¿…è¦çš„é‡å¤è®¡ç®—ã€‚

ä¼˜åŒ–æ–¹æ¡ˆï¼šé€šè¿‡äºŒåˆ†æ³•è®¡ç®—è§†å£ä¸Šçš„é¦–ä¸ªåˆ—è¡¨å…ƒç´ å’Œæœ€åä¸€ä¸ªåˆ—è¡¨å…ƒç´ ç´¢å¼•ï¼Œé€šè¿‡ç´¢å¼•æˆªå–æ‰€éœ€åˆ—è¡¨å…ƒç´ ç„¶åä¸ŠæŠ¥ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š

```js
{
  /**
   * è·å–è§†å£å†…åˆ—è¡¨å…ƒç´ 
   * @params
   * 		topHeight è§†å£é¡¶éƒ¨æˆªå–é«˜åº¦
   *		bottomHeight è§†å£åº•éƒ¨æˆªå–é«˜åº¦
   *		gap åˆ—è¡¨å…ƒç´ é—´éš™
   */
  getScreenItems({ topHeight, bottomHeight, gap }) {
    const firstIndex = this.searchScreenFirstItem(topHeight, gap);
    const lastIndex = this.searchScreenLastItem(bottomHeight, gap);
    console.log(firstIndex, lastIndex);
    const screenItems = this.list.slice(firstIndex, lastIndex + 1);
    return screenItems;
  },
  /**
   * è·å–é¦–ä¸ªåœ¨è§†å£çš„åˆ—è¡¨å…ƒç´ 
   */
  searchScreenFirstItem(topHeight, gap) {
    topHeight = topHeight || 0;
    gap = gap || 0;
    const clientHeight = document.documentElement.clientHeight || document.body.clientHeight;
    const screeenTop = topHeight;
    // åˆ—è¡¨å…ƒç´ ref
    const listItems = this.$refs.listItem;
    if (Array.isArray(listItems)) {
      let low = 0;
      let high = listItems.length - 1;
      let mid;
      while (low <= high) {
        mid = Math.floor((low + high) / 2);
        const itemRect = listItems[mid].getBoundingClientRect();
        if (itemRect.top + itemRect.height + gap < screeenTop) {
          low = mid + 1;
        } else if (itemRect.top > screeenTop) {
          high = mid - 1;
        } else {
          // è¿”å›screenTopå¤„äºitemå…ƒç´ é«˜åº¦ä¹‹é—´çš„ä¸‹ä¸€ä¸ªå…ƒç´ ç´¢å¼•
          // å½“å±å¹•çª—å£å¤§å°å°äºå…ƒç´ é«˜åº¦æ—¶ï¼Œè¿”å›å½“å‰å…ƒç´ ç´¢å¼•
          return itemRect.height < clientHeight ? mid + 1 : mid;
        }
      }
    }
    return 0;
  },
  /**
   * è·å–æœ€åä¸€ä¸ªåœ¨è§†å£çš„åˆ—è¡¨å…ƒç´ 
   */
  searchScreenLastItem(bottomHeight, gap) {
    bottomHeight = bottomHeight || 0;
    gap = gap || 0;
    const clientHeight = document.documentElement.clientHeight || document.body.clientHeight;
    const screenBottom = clientHeight - bottomHeight;
    const listItems = this.$refs.listItem;
    let len = 0;
    if (Array.isArray(listItems)) {
      len = listItems.length;
      let low = 0;
      let high = len - 1;
      let mid;
      while (low <= high) {
        mid = Math.floor((low + high) / 2);
        const itemRect = listItems[mid].getBoundingClientRect();
        if (itemRect.top + itemRect.height < screenBottom) {
          low = mid + 1;
        } else if (itemRect.top - gap > screenBottom) {
          high = mid - 1;
        } else {
          // è¿”å›screenBottomå¤„äºitemå…ƒç´ é«˜åº¦ä¹‹é—´çš„ä¸Šä¸€ä¸ªå…ƒç´ ç´¢å¼•
          // å½“å±å¹•çª—å£å¤§å°å°äºå…ƒç´ é«˜åº¦æ—¶ï¼Œè¿”å›å½“å‰å…ƒç´ ç´¢å¼•
          return itemRect.height < clientHeight ? mid - 1 : mid;
        }
      }
    }
    return len - 1;
  }
}
```



### 3. åŸ‹ç‚¹æ•°æ®ä¸ŠæŠ¥

æœ‰äº†å‰é¢çš„æ­¥éª¤ï¼Œæ•°æ®åŸ‹ç‚¹ä¸ŠæŠ¥å°±æ²¡ä»€ä¹ˆå€¼å¾—è¯´çš„äº†ï¼Œæ— éå°±æ˜¯ç›‘å¬å±å¹•åœç•™ï¼Œç„¶åè¿‡æ»¤å‡ºæ‰€éœ€æ‰€éœ€åˆ—è¡¨å…ƒç´ ï¼Œç„¶åæŠŠåˆ—è¡¨æ•°æ®åŸ‹ç‚¹ç»™ä¸ŠæŠ¥ã€‚

æœ€ç»ˆçš„æ•´ä½“ä»£ç å®ç°å¯ä»¥åˆ°æˆ‘çš„[githubä»“åº“](https://github.com/jackenl/stay-screen)æŸ¥çœ‹ï¼Œå¦‚æœä½ è§‰å¾—ä»¥ä¸Šæ–¹æ¡ˆèƒ½å¤Ÿå¸®åŠ©åˆ°ä½ ï¼Œéº»çƒ¦è¯·ç»™æˆ‘ç‚¹ä¸ªstarï¼Œåœ¨æ­¤ä¸‡åˆ†æ„Ÿè°¢ğŸ™ï¼ï¼ï¼